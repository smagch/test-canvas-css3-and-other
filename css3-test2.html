<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="user-scalable=no, width=device-width"/>
  <title>Webkit CSS3 Test</title>
  <style>
    body {
      	background-color: black;
	    color: white;
	    font-family: 'Lucida Grande', Verdana, Arial;
	    font-size: 12px;
	    background-image: -webkit-gradient(radial,
	                            50% 500, 1,
	                            50% 500, 400,
	                            from(rgba(255, 255, 255, 0.3)),
	                            to(rgba(255, 255, 255, 0)));
	    background-repeat: no-repeat;
    }
	#stage {
        margin: 0 auto;
        width: 0;
        height: 0;
        -webkit-perspective: 800;
		-webkit-transform-style: preserve-3d;
    }
	#world {
		margin: 0 auto;
		position: absolute;
		-webkit-transform-style: preserve-3d;
		
	}
	.box {
		margin: 0 auto;
		position: absolute;

		-webkit-transform-style: preserve-3d;
		/*-webkit-animation-name: y-spin;
				-webkit-animation-duration: 10s;
				-webkit-animation-iteration-count: infinite;
		        -webkit-animation-timing-function: linear;*/
	}
	.plane {
		margin: 0 auto;
		position: absolute;
		background-color:blue;
		opacity: 0.6;
		border:1px solid red;
        -webkit-transform-style: flat;
		
	}
	@-webkit-keyframes y-spin {
        0%    { -webkit-transform: rotateY(0deg); }
        50%   { -webkit-transform: rotateY(180deg); }
        100%  { -webkit-transform: rotateY(360deg); }
    }
  </style>
  <script>

	// requestAnim shim layer by Paul Irish
	window.requestAnimFrame = (function(){
		return  window.requestAnimationFrame       || 
	            window.webkitRequestAnimationFrame || 
	            window.mozRequestAnimationFrame    || 
	            window.oRequestAnimationFrame      || 
	            window.msRequestAnimationFrame     || 
	            function(/* function */ callback, /* DOMElement */ element){
	            	window.setTimeout(callback, 1000 / 60);
	            };
	})();
	
	window.Util = (function(){
		
		var	mat = new WebKitCSSMatrix();
			mats = [	mat,
					mat.rotateAxisAngle(0,1,0,90),
					mat.rotateAxisAngle(0,1,0,180),
					mat.rotateAxisAngle(0,1,0,-90),
					mat.rotateAxisAngle(1,0,0,90),
					mat.rotateAxisAngle(1,0,0,-90) ];
			
					
		return {
			createBox : function(size, parentId) { // width = height = size * 2;
				var parent = document.getElementById(parentId);
				var box = document.createElement('div');
				box.className = 'box';
				
				for(var i = 0; i < 6 ; ++i) {
					var div = document.createElement('div');
					div.className = 'plane';
					div.style.width = size * 2;
					div.style.height = size * 2;
					var m = mats[i];
					div.style.webkitTransform = m.translate(0,0,size);
					box.appendChild(div);
				}
				
				parent.appendChild(box);
				return box;
			}

		};
	})();
	
	var mouseX = 0, mouseY = 0;
	
	window.init = function(){
		
		var cubeNum = 3;
		for(var i = 0; i < cubeNum; i++ ) {
			for(var j = 0; j < cubeNum; j++) {
				for(var k = 0; k < cubeNum; k++) {
					var box = Util.createBox(30, 'world');
					box.style.webkitTransform = 'translateX(' + 70 * ( i - cubeNum/2 ) + 'px) ' + 
												'translateY(' + 70 * ( j - cubeNum/2 ) + 'px) ' + 
												'translateZ(' + 70 * ( k - cubeNum/2 ) + 'px)';
				}
			}
		}

		var world = document.getElementById('world'),
			worldView = new WebKitCSSMatrix(),
			rot = 0,
			halfW = window.outerWidth / 2,
			halfH = window.innerHeight / 2;
		
		var stage = document.getElementById('stage');
		stage.style.webkitPerspectiveOrigin = '50% ' + halfH + 'px';
		
		var halfBoxSize = ( 70 * 3 - 10 ) / 4;
			
		function update() {
			
			// rotate
			// var tranString = window.getComputedStyle(world).webkitTransform;
			// 			var m = new WebKitCSSMatrix(tranString);
			// 			world.style.webkitTransform = m.rotateAxisAngle(0,1,0,1);
			
			//world.style.webkitTransform = worldView.rotateAxisAngle(0,1,0,rot++);
			var rotateY = ( mouseX - halfW ) / halfW * 180,
				rotateX = ( mouseY - halfH ) / halfH * 180;
			//console.log('mouseY : ' + mouseY);
			world.style.webkitTransform = worldView.translate(0,halfH-10 ,0)
				.rotateAxisAngle(0,1,0, rotateY).rotateAxisAngle(1,0,0, rotateX)
				.translate(0, 0, halfBoxSize);
 		}
		
		(function animloop() {
		      update();
		      requestAnimFrame(animloop);
		})();
	};
	
	function mouseMoveHandler (event) {
		mouseX = event.clientX;
		mouseY = event.clientY;
	}
	function mouseDownHandler(event) {
		console.log('click');
		// var world = document.getElementById('world');
		// 		var tranString = window.getComputedStyle(world).webkitTransform;
		// 		var m = new WebKitCSSMatrix(tranString);
		// 		world.style.webkitTransform = m.translate(0,0,100);
	}
	
  </script>
</head>
<body onload='init()' onmousedown='mouseDownHandler(event)' onmousemove='mouseMoveHandler(event)'>
	<div id='stage'>
		<div id='world'>
		</div>
	</div>
  
</body>
</html>
